name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  CLUSTER_NAME: dummy-cluster
  NAMESPACE: crework-trello

jobs:
  cd:
    name: CD – Kubernetes Deploy + DAST (Dummy)
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      # -------------------------
      # Checkout repository
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Install kubectl
      # -------------------------
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.28.0

      # -------------------------
      # Install kind
      # -------------------------
      - name: Install kind
        run: |
          curl -Lo kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind

      # -------------------------
      # Create KIND cluster
      # -------------------------
      - name: Create kind cluster
        run: |
          kind create cluster --name $CLUSTER_NAME
          kubectl cluster-info

      # -------------------------
      # Create Namespace
      # -------------------------
      - name: Create namespace
        run: |
          kubectl create namespace $NAMESPACE || true
          kubectl config set-context --current --namespace=$NAMESPACE

      # -------------------------
      # Create DockerHub pull secret
      # -------------------------
      - name: Create DockerHub pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} \
            --docker-email=${{ secrets.DOCKERHUB_EMAIL }} \
            --namespace=$NAMESPACE || true

      # -------------------------
      # Create backend configmap
      # -------------------------
      - name: Create backend configmap
        run: |
          kubectl create configmap backend-config \
            --from-literal=PORT=8081 \
            --namespace=$NAMESPACE || true

      # -------------------------
      # Create backend secrets
      # -------------------------
      - name: Create backend secrets
        run: |
          kubectl create secret generic backend-secrets \
            --from-literal=mongodb-uri="${{ secrets.MONGODB_URI }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --namespace=$NAMESPACE || true

      # -------------------------
      # Deploy Backend
      # -------------------------
      - name: Deploy Backend
        run: |
          kubectl apply -f k8s/backend-deployment.yaml
          kubectl apply -f k8s/backend-service.yaml
          kubectl rollout status deployment/backend-deployment --timeout=5m

      # -------------------------
      # Deploy Frontend
      # -------------------------
      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/frontend-deployment.yaml
          kubectl apply -f k8s/frontend-service.yaml
          kubectl rollout status deployment/frontend-deployment --timeout=5m

      # -------------------------
      # Verify Resources
      # -------------------------
      - name: Verify deployments
        run: |
          kubectl get pods -n $NAMESPACE
          kubectl get services -n $NAMESPACE
          kubectl get deployments -n $NAMESPACE

      # -------------------------
      # Dummy DAST
      # -------------------------
      - name: Dummy DAST Check
        run: |
          echo "Running dummy DAST checks..."
          kubectl get svc -n $NAMESPACE
          echo "DAST completed"

      # -------------------------
      # OWASP ZAP (Dummy)
      # -------------------------
      - name: OWASP ZAP Baseline Scan (Dummy)
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: http://example.com
          cmd_options: '-a'
        continue-on-error: true

      # -------------------------
      # Summary
      # -------------------------
      - name: CD Summary
        if: always()
        run: |
          echo "## CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ KIND cluster created" >> $GITHUB_STEP_SUMMARY
          echo "✅ Backend & Frontend deployed" >> $GITHUB_STEP_SUMMARY
          echo "✅ Secrets & ConfigMaps injected" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dummy DAST executed" >> $GITHUB_STEP_SUMMARY

      # -------------------------
      # Cleanup
      # -------------------------
      - name: Delete kind cluster
        if: always()
        run: |
          kind delete cluster --name $CLUSTER_NAME
